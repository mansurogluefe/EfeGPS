<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Efe CanlÄ± Ã‡eviri - % Progress + Kalan Saniye</title>
<style>
  body {font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;background:#0f172a;color:#e2e8f0;margin:0;padding:20px;}
  h1 {text-align:center;font-size:26px;margin:20px 0;color:#60a5fa;}
  .box {background:#1e293b;padding:24px;border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,0.6);}
  button {padding:16px 32px;margin:8px;border:none;border-radius:16px;font-weight:700;font-size:17px;cursor:pointer;}
  button.start {background:#2563eb;color:white;}
  button.stop {background:#dc2626;color:white;}
  button:disabled {opacity:0.5;cursor:not-allowed;}
  #status {margin-left:15px;font-size:17px;color:#93c5fd;font-weight:600;}
  
  .chat {display:flex;flex-direction:column;gap:16px;margin-top:20px;}
  .bubble {max-width:90%;padding:18px 22px;border-radius:22px;line-height:1.6;font-size:18px;word-wrap:break-word;}
  .en {align-self:flex-start;background:#1e40af;color:white;}
  .tr {align-self:flex-end;background:#16a34a;color:white;}

  #logPanel {position:fixed;bottom:0;left:0;right:0;height:280px;background:#000;color:#0f0;padding:15px;font-family:monospace;font-size:14px;overflow-y:auto;border-top:4px solid #00ff00;z-index:9999;display:none;box-sizing:border-box;}
  #logPanel.show {display:block;}
  #showLog {position:fixed;bottom:20px;right:20px;background:#00ff00;color:#000;padding:14px 24px;border-radius:50px;font-weight:bold;z-index:10000;box-shadow:0 6px 30px rgba(0,255,0,0.6);}
</style>
</head>
<body>

<h1>Efe CanlÄ± Ã‡eviri - % Progress GÃ¶steren</h1>

<div class="box">
  <button id="startBtn" class="start">BaÅŸlat</button>
  <button id="stopBtn" class="stop" disabled>Durdur</button>
  <span id="status">Model bekleniyor...</span>
</div>

<div class="chat" id="chat"></div>

<button id="showLog">LOG AÃ‡</button>
<div id="logPanel">
  <div style="color:#ff0">CanlÄ± log aktif â€“ model yÃ¼kleme yÃ¼zdesi burada gÃ¶zÃ¼kecek</div>
</div>

<script type="module">
import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';

const DEEPGRAM_KEY = "8b58f8fcf792acd4b0e5d823c3ddf68c8f70af40";
let processor, audioStream, translator = null;
const logPanel = document.getElementById("logPanel");
const showLogBtn = document.getElementById("showLog");
const statusEl = document.getElementById("status");

let startTime = null;

function log(msg, error = false) {
  const line = document.createElement("div");
  line.textContent = new Date().toLocaleTimeString() + " â†’ " + msg;
  line.style.color = error ? "#ff3333" : "#33ff99";
  logPanel.appendChild(line);
  logPanel.scrollTop = logPanel.scrollHeight;
  console.log("[LOG]", msg);
}

showLogBtn.addEventListener("click", () => {
  const isShown = logPanel.classList.toggle("show");
  showLogBtn.textContent = isShown ? "LOG KAPAT" : "LOG AÃ‡";
});

function addBubble(text, type) {
  if (!text?.trim()) return;
  const div = document.createElement("div");
  div.className = `bubble ${type}`;
  div.textContent = text.trim();
  document.getElementById("chat").insertBefore(div, document.getElementById("chat").firstChild);
  window.scrollTo({top: 0, behavior: "smooth"});
}

function pcmToWav(samples) {
  const buffer = new ArrayBuffer(44 + samples.length * 2);
  const view = new DataView(buffer);
  const write = (o,s) => [...s].forEach((c,i)=>view.setUint8(o+i,c.charCodeAt()));
  write(0,"RIFF"); view.setUint32(4,36+samples.length*2,true); write(8,"WAVE");
  write(12,"fmt "); view.setUint32(16,16,true); view.setUint16(20,1,true);
  view.setUint16(22,1,true); view.setUint32(24,44100,true); view.setUint32(28,88200,true);
  view.setUint16(32,2,true); view.setUint16(34,16,true); write(36,"data"); view.setUint32(40,samples.length*2,true);
  let offset = 44;
  for (let i = 0; i < samples.length; i++) {
    const s = Math.max(-1, Math.min(1, samples[i]));
    view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
    offset += 2;
  }
  return new Blob([buffer], {type: "audio/wav"});
}

// MODEL YÃœKLEME + % + KALAN SANÄ°YE
async function loadModel() {
  if (translator) return translator;

  log("Xenova/opus-mt-en-tr modeli indirilmeye baÅŸlandÄ±...");
  statusEl.textContent = "Model indiriliyor... %0";
  startTime = Date.now();

  try {
    translator = await pipeline('translation', 'Xenova/opus-mt-en-tr', {
      // Progress callback â€“ her dosya indirildiÄŸinde tetiklenir
      progress_callback: (data) => {
        if (data.status === 'downloading' || data.status === 'loading') {
          const percent = Math.round(data.progress || 0);
          const elapsed = (Date.now() - startTime) / 1000;
          const estimatedTotal = elapsed / (percent / 100);
          const remaining = Math.max(0, Math.round(estimatedTotal - elapsed));

          log(`%${percent} â†’ Model indiriliyor... (tahmini ${remaining} saniye kaldÄ±)`);
          statusEl.textContent = `Model indiriliyor... %${percent} (${remaining}s kaldÄ±)`;
        }
      }
    });

    log("%100 â†’ MODEL BAÅžARIYLA YÃœKLENDÄ°! Offline Ã§eviri aktif ðŸ”¥");
    statusEl.textContent = "HazÄ±r â€“ KonuÅŸ!";
  } catch (e) {
    log("Model yÃ¼kleme HATASI: " + e.message, true);
    statusEl.textContent = "Model yÃ¼klenemedi â€“ Yenile";
  }
  return translator;
}

async function translate(text) {
  if (!translator) await loadModel();
  if (!translator) return text + " (model yok)";
  const out = await translator(text);
  return out[0].translation_text;
}

async function recognize(blob) {
  const res = await fetch("https://api.deepgram.com/v1/listen?model=nova-2&language=en&punctuate=true", {
    method: "POST",
    headers: { "Authorization": `Token ${DEEPGRAM_KEY}`, "Content-Type": "audio/wav" },
    body: blob
  });
  if (!res.ok) throw new Error("Deepgram " + res.status);
  const json = await res.json();
  return json.results.channels[0].alternatives[0].transcript.trim();
}

async function processChunk(samples) {
  statusEl.textContent = "Ã‡evriliyor...";
  const blob = pcmToWav(samples);
  try {
    const eng = await recognize(blob);
    if (!eng || eng.length < 3) return;
    log("Ä°NG: " + eng);
    addBubble(eng, "en");
    const tr = await translate(eng);
    log("TR: " + tr);
    addBubble(tr, "tr");
    statusEl.textContent = "Dinliyor...";
  } catch (e) {
    log("Hata: " + e.message, true);
  }
}

document.getElementById("startBtn").onclick = async () => {
  try {
    audioStream = await navigator.mediaDevices.getUserMedia({audio: true});
    log("Mikrofon aÃ§Ä±ldÄ±");

    const ctx = new AudioContext();
    const source = ctx.createMediaStreamSource(audioStream);
    processor = ctx.createScriptProcessor(4096, 1, 1);
    const samples = [];

    processor.onaudioprocess = e => {
      samples.push(...e.inputBuffer.getChannelData(0));
      if (samples.length >= 44100 * 4) {
        const chunk = samples.splice(0, 44100 * 4);
        processChunk(chunk);
      }
    };

    source.connect(processor);
    processor.connect(ctx.destination);

    document.getElementById("startBtn").disabled = true;
    document.getElementById("stopBtn").disabled = false;
    log("CanlÄ± Ã§eviri baÅŸladÄ± â€“ model yÃ¼kleme % ile takip ediliyor");
  } catch (e) {
    log("Mikrofon hatasÄ±: " + e.message, true);
    alert("Mikrofon izni ver!");
  }
};

document.getElementById("stopBtn").onclick = () => {
  if (processor) processor.disconnect();
  if (audioStream) audioStream.getTracks().forEach(t => t.stop());
  document.getElementById("startBtn").disabled = false;
  document.getElementById("stopBtn").disabled = true;
  statusEl.textContent = "Durduruldu";
  log("Durduruldu");
};
</script>
</body>
</html>