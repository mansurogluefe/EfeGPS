<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Efe Canlı Çeviri — Lingva Sürümü</title>
<style>
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;background:#071024;color:#e6f0ff;margin:0;padding:20px;}
h1{text-align:center;font-size:24px;margin:12px 0;color:#60a5fa;}
.box{background:#0f1724;padding:18px;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,0.6);max-width:980px;margin:12px auto;}
.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
button{padding:10px 14px;border:none;border-radius:12px;font-weight:700;font-size:15px;cursor:pointer;}
button.primary{background:#2563eb;color:white;}
button.warn{background:#dc2626;color:white;}
button.ghost{background:transparent;border:1px solid #2b3440;color:#cfe6ff;}
button:disabled{opacity:0.45;cursor:not-allowed;}
#status{margin-left:12px;font-size:15px;color:#93c5fd;font-weight:600;}
.chat{display:flex;flex-direction:column;gap:12px;margin-top:18px;max-width:980px;margin-left:auto;margin-right:auto;}
.bubble{max-width:86%;padding:12px 16px;border-radius:14px;line-height:1.45;font-size:15px;word-wrap:break-word;}
.en{align-self:flex-start;background:#1e40af;color:white;}
.tr{align-self:flex-end;background:#16a34a;color:white;}
#logPanel{position:fixed;bottom:0;left:0;right:0;height:300px;background:#020200;color:#00ff88;padding:12px;font-family:monospace;font-size:13px;overflow-y:auto;border-top:4px solid #00cc88;z-index:9999;display:none;box-sizing:border-box;}
#logPanel.show{display:block;}
#showLog{position:fixed;bottom:18px;right:18px;background:#00ff88;color:#022;border-radius:40px;padding:10px 14px;font-weight:bold;z-index:10000;box-shadow:0 6px 30px rgba(0,255,150,0.15);}
</style>
</head>
<body>

<h1>Efe Canlı Çeviri — Lingva Sürümü</h1>

<div class="box">
<div class="controls">
<button id="startBtn" class="primary">Başlat</button>
<button id="stopBtn" class="warn" disabled>Durdur</button>
<span id="status">Hazır</span>
</div>
</div>

<div class="chat" id="chat"></div>
<button id="showLog">LOG AÇ</button>
<div id="logPanel">
<div style="color:#ffcc00">Canlı log: işlem durumu ve hatalar burada.</div>
</div>

<script>
const DEEPGRAM_KEY="8b58f8fcf792acd4b0e5d823c3ddf68c8f70af40";

const startBtn=document.getElementById('startBtn');
const stopBtn=document.getElementById('stopBtn');
const statusEl=document.getElementById('status');
const chatEl=document.getElementById('chat');
const logPanel=document.getElementById('logPanel');
const showLogBtn=document.getElementById('showLog');

let audioStream=null;
let audioCtx=null;
let processor=null;

function log(msg,isError=false){
  const line=document.createElement('div');
  line.textContent=`${new Date().toLocaleTimeString()} → ${msg}`;
  line.style.color=isError?'#ff6b6b':'#7efc9b';
  logPanel.appendChild(line);
  logPanel.scrollTop=logPanel.scrollHeight;
  console.log('[LOG]',msg);
}

showLogBtn.addEventListener('click',()=>{const s=logPanel.classList.toggle('show');showLogBtn.textContent=s?'LOG KAPAT':'LOG AÇ';});

function addBubble(text,type){
  if(!text?.trim()) return;
  const d=document.createElement('div');
  d.className=`bubble ${type}`;
  d.textContent=text.trim();
  chatEl.insertBefore(d,chatEl.firstChild);
}

function pcmToWav(samples,sampleRate=44100){
  const numChannels=1,bitsPerSample=16,blockAlign=numChannels*bitsPerSample/8,byteRate=sampleRate*blockAlign,dataSize=samples.length*bitsPerSample/8;
  const buffer=new ArrayBuffer(44+dataSize);
  const view=new DataView(buffer);
  let offset=0;
  function wStr(o,s){for(let i=0;i<s.length;i++)view.setUint8(o+i,s.charCodeAt(i));}
  wStr(offset,'RIFF'); offset+=4; view.setUint32(offset,36+dataSize,true); offset+=4; wStr(offset,'WAVE'); offset+=4; wStr(offset,'fmt '); offset+=4; view.setUint32(offset,16,true); offset+=4; view.setUint16(offset,1,true); offset+=2; view.setUint16(offset,numChannels,true); offset+=2; view.setUint32(offset,sampleRate,true); offset+=4; view.setUint32(offset,byteRate,true); offset+=4; view.setUint16(offset,blockAlign,true); offset+=2; view.setUint16(offset,bitsPerSample,true); offset+=2; wStr(offset,'data'); offset+=4; view.setUint32(offset,dataSize,true); offset+=4;
  let pos=44; for(let i=0;i<samples.length;i++,pos+=2){ const s=Math.max(-1,Math.min(1,samples[i])); view.setInt16(pos,s<0?s*0x8000:s*0x7FFF,true);}
  return new Blob([view],{type:'audio/wav'});
}

async function recognize(blob){
  const res=await fetch("https://api.deepgram.com/v1/listen?model=nova-2&language=en&punctuate=true",{
    method:"POST",
    headers:{"Authorization":`Token ${DEEPGRAM_KEY}`,"Content-Type":"audio/wav"},
    body:blob
  });
  if(!res.ok) throw new Error('Deepgram '+res.status+' '+res.statusText);
  const json=await res.json();
  const alt=json?.results?.channels?.[0]?.alternatives?.[0];
  return (alt&&alt.transcript)?alt.transcript.trim():'';
}

async function translateLingva(text){
  if(!text || text.length<1) return '';
  try{
    const res=await fetch(`https://lingva.ml/api/v1/en/tr/${encodeURIComponent(text)}`);
    if(!res.ok) throw new Error('Lingva API '+res.status);
    const json=await res.json();
    return json.translation||'';
  }catch(e){
    log('Lingva hatası: '+e.message,true);
    return text+' (çeviri hatası)';
  }
}

async function processChunk(samples){
  statusEl.textContent='Çevriliyor...';
  const blob=pcmToWav(samples);
  try{
    const eng=await recognize(blob);
    if(!eng){statusEl.textContent='Dinliyor...'; return;}
    log('İNG: '+eng);
    addBubble(eng,'en');
    const tr=await translateLingva(eng);
    log('TR: '+tr);
    addBubble(tr,'tr');
    statusEl.textContent='Dinliyor...';
  }catch(e){
    log('Hata: '+e.message,true);
    statusEl.textContent='Hata oluştu';
  }
}

startBtn.addEventListener('click',async()=>{
  startBtn.disabled=true; stopBtn.disabled=false;
  statusEl.textContent='Mikrofon açılıyor...';
  try{
    audioStream=await navigator.mediaDevices.getUserMedia({audio:true});
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    const source=audioCtx.createMediaStreamSource(audioStream);
    processor=audioCtx.createScriptProcessor(4096,1,1);
    const buffer=[]; const chunkSize=audioCtx.sampleRate*2;
    processor.onaudioprocess=(e)=>{
      const ch=e.inputBuffer.getChannelData(0);
      for(let i=0;i<ch.length;i++) buffer.push(ch[i]);
      if(buffer.length>=chunkSize){ const chunk=buffer.splice(0,chunkSize); processChunk(chunk);}
    };
    source.connect(processor); processor.connect(audioCtx.destination);
    statusEl.textContent='Dinliyor...';
    log('Canlı çeviri başladı.');
  }catch(e){
    log('Mikrofon hatası: '+e.message,true);
    alert('Mikrofon izni ver veya tarayıcı izinlerini kontrol et!');
    startBtn.disabled=false; stopBtn.disabled=true;
    statusEl.textContent='Mikrofon açma hatası';
  }
});

stopBtn.addEventListener('click',()=>{
  try{
    if(processor){processor.disconnect(); processor.onaudioprocess=null; processor=null;}
    if(audioCtx){audioCtx.close(); audioCtx=null;}
    if(audioStream){ audioStream.getTracks().forEach(t=>t.stop()); audioStream=null;}
    startBtn.disabled=false; stopBtn.disabled=true;
    statusEl.textContent='Durduruldu';
    log('Canlı çeviri durduruldu.');
  }catch(e){log('Durdurma hatası: '+e.message,true);}
});
</script>

</body>
</html>