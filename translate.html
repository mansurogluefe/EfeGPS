<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Efe Canlı Çeviri — Çalışır Model</title>
<style>
  body {font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;background:#071024;color:#e6f0ff;margin:0;padding:22px;}
  h1 {text-align:center;font-size:24px;margin:12px 0;color:#60a5fa;}
  .box {background:#0f1724;padding:18px;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,0.6);max-width:980px;margin:12px auto;}
  .controls {display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
  button {padding:10px 14px;border:none;border-radius:12px;font-weight:700;font-size:15px;cursor:pointer;}
  button.primary {background:#2563eb;color:white;}
  button.warn {background:#dc2626;color:white;}
  button.ghost {background:transparent;border:1px solid #2b3440;color:#cfe6ff;}
  button:disabled {opacity:0.45;cursor:not-allowed;}
  #status {margin-left:12px;font-size:15px;color:#93c5fd;font-weight:600;}
  .progressWrap {margin-top:12px;background:#071827;padding:10px;border-radius:12px;border:1px solid #0e3a66;}
  .progressBar {height:18px;background:#08345a;border-radius:10px;overflow:hidden;position:relative;}
  .progressBar > i {position:absolute;left:0;top:0;bottom:0;width:0%;background:#2dd4bf;border-radius:10px;transition:width 260ms linear;}
  .progressInfo {display:flex;justify-content:space-between;font-size:13px;margin-top:8px;color:#a7d2ff;}
  .chat {display:flex;flex-direction:column;gap:12px;margin-top:18px;max-width:980px;margin-left:auto;margin-right:auto;}
  .bubble {max-width:86%;padding:12px 16px;border-radius:14px;line-height:1.45;font-size:15px;word-wrap:break-word;}
  .en {align-self:flex-start;background:#1e40af;color:white;}
  .tr {align-self:flex-end;background:#16a34a;color:white;}
  #logPanel {position:fixed;bottom:0;left:0;right:0;height:300px;background:#020200;color:#00ff88;padding:12px;font-family:monospace;font-size:13px;overflow-y:auto;border-top:4px solid #00cc88;z-index:9999;display:none;box-sizing:border-box;}
  #logPanel.show {display:block;}
  #showLog {position:fixed;bottom:18px;right:18px;background:#00ff88;color:#022;border-radius:40px;padding:10px 14px;font-weight:bold;z-index:10000;box-shadow:0 6px 30px rgba(0,255,150,0.15);}
  .small {font-size:13px;color:#9fc9ff;}
  .metaRow {display:flex;gap:14px;align-items:center;margin-top:8px;}
  .pill {padding:6px 10px;border-radius:999px;background:#06283a;color:#bfefff;font-weight:600;font-size:13px;border:1px solid #093b52;}
</style>
</head>
<body>

<h1>Efe Canlı Çeviri — Çalışır Model</h1>

<div class="box">
  <div class="controls">
    <button id="downloadModelBtn" class="primary">Model İndir</button>
    <button id="cancelDownloadBtn" class="ghost" disabled>İptal</button>
    <button id="startBtn" class="primary" disabled>Başlat</button>
    <button id="stopBtn" class="warn" disabled>Durdur</button>
    <button id="retryModelBtn" class="ghost" disabled>Yeniden Dene</button>
    <span id="status">Model: indirilmeyi bekliyor...</span>
  </div>

  <div class="progressWrap">
    <div class="progressBar" id="progressBar"><i id="progressFill"></i></div>
    <div class="progressInfo">
      <div><span id="percentText">0%</span> • <span id="timeText">—</span></div>
      <div class="small"><span id="modeText">Mod: bekleme</span></div>
    </div>
  </div>

  <div class="metaRow">
    <div class="pill" id="modelIdPill">Model: <strong id="modelIdText">Xenova/nllb-200-distilled-600M</strong></div>
    <div class="small">Not: Bu model tarayıcı destekli ve CORS hatası vermez.</div>
  </div>

</div>

<div class="chat" id="chat"></div>

<button id="showLog">LOG AÇ</button>
<div id="logPanel">
  <div style="color:#ffcc00">Canlı log: indirme durumları, hata ve olaylar burada.</div>
</div>

<script type="module">
import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2/dist/transformers.min.js';

const DEEPGRAM_KEY = "8b58f8fcf792acd4b0e5d823c3ddf68c8f70af40";

const downloadModelBtn = document.getElementById('downloadModelBtn');
const cancelDownloadBtn = document.getElementById('cancelDownloadBtn');
const retryModelBtn = document.getElementById('retryModelBtn');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');

const statusEl = document.getElementById('status');
const percentText = document.getElementById('percentText');
const timeText = document.getElementById('timeText');
const progressFill = document.getElementById('progressFill');
const modeText = document.getElementById('modeText');

const logPanel = document.getElementById('logPanel');
const showLogBtn = document.getElementById('showLog');
const chatEl = document.getElementById('chat');

let translator = null;
let loadingSimInterval = null;
let simulatedPercent = 0;
let loadingStart = 0;
let lastProgressTime = 0;
let lastProgressPercent = 0;
let cancelRequested = false;
let downloadAbortController = null;

/* Audio vars */
let audioStream = null;
let audioCtx = null;
let processor = null;

/* Config */
const MODEL_ID = 'Xenova/nllb-200-distilled-600M'; 

function log(msg, isError=false){
  const line = document.createElement('div');
  line.textContent = `${new Date().toLocaleTimeString()} → ${msg}`;
  line.style.color = isError?'#ff6b6b':'#7efc9b';
  logPanel.appendChild(line);
  logPanel.scrollTop = logPanel.scrollHeight;
  console.log('[LOG]', msg);
}
showLogBtn.addEventListener('click', ()=>{
  const s=logPanel.classList.toggle('show');
  showLogBtn.textContent = s?'LOG KAPAT':'LOG AÇ';
});

function addBubble(text,type){
  if(!text?.trim()) return;
  const d = document.createElement('div');
  d.className = `bubble ${type}`;
  d.textContent = text.trim();
  chatEl.insertBefore(d, chatEl.firstChild);
}

function setProgress(p,note=''){
  p=Math.max(0,Math.min(100,Math.round(p)));
  percentText.textContent = p+'%';
  progressFill.style.width = p+'%';
  if(note) modeText.textContent=note;
}
function setStatus(s){ statusEl.textContent=s; }

function pcmToWav(samples,sampleRate=44100){
  const numChannels=1,bitsPerSample=16,blockAlign=numChannels*bitsPerSample/8,byteRate=sampleRate*blockAlign,dataSize=samples.length*bitsPerSample/8;
  const buffer=new ArrayBuffer(44+dataSize);
  const view=new DataView(buffer);
  let offset=0;
  function wStr(o,s){for(let i=0;i<s.length;i++)view.setUint8(o+i,s.charCodeAt(i));}
  wStr(offset,'RIFF'); offset+=4; view.setUint32(offset,36+dataSize,true); offset+=4;
  wStr(offset,'WAVE'); offset+=4; wStr(offset,'fmt '); offset+=4; view.setUint32(offset,16,true); offset+=4;
  view.setUint16(offset,1,true); offset+=2; view.setUint16(offset,numChannels,true); offset+=2; view.setUint32(offset,sampleRate,true); offset+=4; view.setUint32(offset,byteRate,true); offset+=4;
  view.setUint16(offset,blockAlign,true); offset+=2; view.setUint16(offset,bitsPerSample,true); offset+=2; wStr(offset,'data'); offset+=4; view.setUint32(offset,dataSize,true); offset+=4;
  let pos=44; for(let i=0;i<samples.length;i++,pos+=2){ const s=Math.max(-1,Math.min(1,samples[i])); view.setInt16(pos,s<0?s*0x8000:s*0x7FFF,true);}
  return new Blob([view],{type:'audio/wav'});
}

async function recognize(blob){
  const res=await fetch("https://api.deepgram.com/v1/listen?model=nova-2&language=en&punctuate=true",{method:"POST",headers:{"Authorization":`Token ${DEEPGRAM_KEY}`,"Content-Type":"audio/wav"},body:blob});
  if(!res.ok)throw new Error('Deepgram '+res.status+' '+res.statusText);
  const json=await res.json();
  const alt=json?.results?.channels?.[0]?.alternatives?.[0];
  return (alt&&alt.transcript)?alt.transcript.trim():'';
}

async function translate(text){
  if(!translator) {
    await loadModelInternal();
    if(!translator) return text+' (çeviri yok)';
  }
  try{
    const out=await translator(text);
    if(Array.isArray(out)&&out[0]?.translation_text) return out[0].translation_text;
    return (out&&out.translation_text)||text;
  }catch(e){log('Çeviri hatası: '+e.message,true);return text+' (çeviri hatası)';}
}

async function processChunk(samples){
  setStatus('Çevriliyor...');
  const blob=pcmToWav(samples);
  try{
    const eng=await recognize(blob);
    if(!eng){ setStatus('Dinliyor...'); return; }
    log('İNG: '+eng);
    addBubble(eng,'en');
    const tr=await translate(eng);
    log('TR: '+tr);
    addBubble(tr,'tr');
    setStatus('Dinliyor...');
  }catch(e){ log('Hata: '+e.message,true); setStatus('Hata oluştu'); }
}

async function loadModelInternal(){
  if(translator) return translator;
  cancelRequested=false;
  downloadAbortController=new AbortController();
  setStatus('Model indiriliyor...');
  setProgress(0,'Mod: indiriliyor');
  loadingStart=Date.now(); lastProgressPercent=0; simulatedPercent=0;

  loadingSimInterval=setInterval(()=>{
    if(simulatedPercent<98){ simulatedPercent+=Math.max(1,Math.floor(Math.random()*6)); setProgress(simulatedPercent,'Mod: simülasyon'); lastProgressPercent=simulatedPercent;}
  },350);

  try{
    translator=await pipeline('translation',MODEL_ID,{signal:downloadAbortController.signal,progress_callback:(data)=>{
      const p=Math.round(data.progress||0);
      lastProgressPercent=p;
      setProgress(p,`Mod: gerçek (stage:${data.status||'??'})`);
      log('progress callback: '+JSON.stringify(data));
    }});

    if(cancelRequested) throw new Error('İndirme iptal edildi');
    setProgress(100,'Mod: hazır');
    timeText.textContent='0s kaldı';
    setStatus('Model hazır — çeviri aktif');
    downloadModelBtn.disabled=true; cancelDownloadBtn.disabled=true; retryModelBtn.disabled=false; startBtn.disabled=false;
    log('%100 → MODEL BAŞARIYLA YÜKLENDİ!');
    return translator;
  }catch(e){
    if(cancelRequested){ setStatus('İndirme iptal edildi'); setProgress(0,'Mod: iptal'); log('İptal edildi.'); }
    else{ setStatus('Model yükleme HATASI'); setProgress(0,'Mod: hata'); log('Model yükleme HATASI: '+e.message,true);}
    translator=null;
    downloadModelBtn.disabled=false; cancelDownloadBtn.disabled=true; retryModelBtn.disabled=false; startBtn.disabled=true;
    return null;
  }finally{
    clearInterval(loadingSimInterval);
  }
}

/* Düğmeler */
downloadModelBtn.addEventListener('click',async()=>{
  downloadModelBtn.disabled=true; cancelDownloadBtn.disabled=false; retryModelBtn.disabled=true; setStatus('Model indiriliyor...');
  await loadModelInternal();
});
cancelDownloadBtn.addEventListener('click',()=>{
  cancelRequested=true;
  try{ downloadAbortController?.abort(); }catch{}
  cancelDownloadBtn.disabled=true; downloadModelBtn.disabled=false; retryModelBtn.disabled=false;
  setStatus('İptal isteği gönderildi'); log('Kullanıcı indirme iptal etti.');
});
retryModelBtn.addEventListener('click',async()=>{
  retryModelBtn.disabled=true; downloadModelBtn.disabled=true; cancelDownloadBtn.disabled=false;
  setStatus('Yeniden deneme...');
  await loadModelInternal();
});

startBtn.addEventListener('click',async()=>{
  startBtn.disabled=true; stopBtn.disabled=false; setStatus('Mikrofon açılıyor...');
  if(!translator){ setStatus('Model hazır değil, indiriliyor otomatik...'); await loadModelInternal(); }
  try{
    audioStream=await navigator.mediaDevices.getUserMedia({audio:true});
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    const source=audioCtx.createMediaStreamSource(audioStream);
    processor=audioCtx.createScriptProcessor(4096,1,1);
    const buffer=[]; const chunkSize=audioCtx.sampleRate*2;
    processor.onaudioprocess=(e)=>{
      const ch=e.inputBuffer.getChannelData(0);
      for(let i=0;i<ch.length;i++) buffer.push(ch[i]);
      if(buffer.length>=chunkSize){ const chunk=buffer.splice(0,chunkSize); processChunk(chunk);}
    };
    source.connect(processor); processor.connect(audioCtx.destination);
    setStatus('Dinliyor...'); log('Canlı çeviri başladı.');
  }catch(e){ log('Mikrofon hatası: '+e.message,true); alert('Mikrofon izni ver veya tarayıcı izinlerini kontrol et!'); startBtn.disabled=false; stopBtn.disabled=true; setStatus('Mikrofon açma hatası'); }
});

stopBtn.addEventListener('click',async()=>{
  try{
    if(processor){processor.disconnect();processor.onaudioprocess=null;processor=null;}
    if(audioCtx){ try{audioCtx.close();}catch{} audioCtx=null;}
    if(audioStream){ audioStream.getTracks().forEach(t=>t.stop()); audioStream=null;}
    startBtn.disabled=false; stopBtn.disabled=true;
    setStatus('Durduruldu'); log('Canlı çeviri durduruldu.');
  }catch(e){ log('Durdurma hatası: '+e.message,true);}
});

/* Başlangıç durumları */
setProgress(0,'Mod: bekleme'); setStatus('Model: indirilmeyi bekliyor...');
downloadModelBtn.disabled=false; cancelDownloadBtn.disabled=true; retryModelBtn.disabled=true; startBtn.disabled=true; stopBtn.disabled=true;

</script>
</body>
</html>