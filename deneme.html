<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EfeGPS - Akıllı Rota Analizi</title>

    <meta http-equiv="Content-Security-Policy" content="default-src * 'self' blob: data: gap:; style-src * 'self' 'unsafe-inline'; script-src * 'self' 'unsafe-inline' 'unsafe-eval'; connect-src * 'self' blob: data:;">
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <meta name="theme-color" content="#005eff"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="stylesheet" href="style.css">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1" crossorigin="anonymous"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js" crossorigin="anonymous"></script>

    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js" crossorigin="anonymous"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js" crossorigin="anonymous"></script>

    <style>
        /* Telegram Uyarı Çubuğu Stili */
        #telegram-warning {
            display: none; /* Varsayılan olarak gizli */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #ff3b30;
            color: white;
            z-index: 9999;
            padding: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-size: 14px;
        }
        #telegram-warning button {
            background: white;
            color: #ff3b30;
            border: none;
            padding: 5px 15px;
            border-radius: 15px;
            margin-left: 10px;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
</head>
<body data-theme="light">

<div id="telegram-warning">
    ⚠️ Bağlantı sorunu yaşamamak için tarayıcıda açın.
    <button onclick="openInSystemBrowser()">Safari'de Aç</button>
</div>

<div id="mobile-header">
    <div class="header-left">
        <button id="menu-toggle" class="icon-btn" aria-label="Menüyü aç">
            <ion-icon name="menu" aria-hidden="true"></ion-icon>
        </button>
        <h1>EfeGPS</h1>
    </div>
    <div class="header-right">
        <button id="theme-toggle" class="icon-btn" aria-label="Tema değiştir">
            <ion-icon name="contrast" aria-hidden="true"></ion-icon>
        </button>
    </div>
</div>

<div id="map" aria-label="Harita"></div>

<div id="bottom-sheet">
    <div class="sheet-handle" aria-hidden="true"></div>
    <div class="sheet-content">
        <canvas id="analyticsChart" aria-label="Analiz grafiği"></canvas>
    </div>
</div>

<div id="mobile-sidebar" class="sidebar-hidden">
    <div class="sidebar-header">
        <h2>Analiz Paneli</h2>
        <button id="sidebar-close" class="icon-btn" aria-label="Menüyü kapat">
            <ion-icon name="close" aria-hidden="true"></ion-icon>
        </button>
    </div>

    <div class="sidebar-content">
        <div class="quick-date-selector">
            <button class="date-btn active" data-days="0" aria-label="Bugün">Bugün</button>
            <button class="date-btn" data-days="1" aria-label="Dün">Dün</button>
            <button class="date-btn" data-days="7" aria-label="Bu hafta">Bu Hafta</button>
        </div>

        <div class="filter-section">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="datePicker">Tarih</label>
                    <input type="date" id="datePicker" class="filter-input" aria-label="Tarih seçin">
                </div>
                <div class="filter-group">
                    <label for="startTime">Başlangıç Saati</label>
                    <input type="time" id="startTime" class="filter-input" value="00:00" aria-label="Başlangıç saati">
                </div>
                <div class="filter-group">
                    <label for="endTime">Bitiş Saati</label>
                    <input type="time" id="endTime" class="filter-input" value="23:59" aria-label="Bitiş saati">
                </div>
            </div>
            <button id="apply-filters" class="btn-primary" aria-label="Filtreleri uygula">
                <ion-icon name="filter" aria-hidden="true"></ion-icon>
                Filtrele
            </button>
        </div>

        <div class="summary-cards">
            <div class="stat-card">
                <div class="stat-icon" aria-hidden="true">
                    <ion-icon name="speedometer"></ion-icon>
                </div>
                <div class="stat-info">
                    <div class="stat-value" id="total-distance">-</div>
                    <div class="stat-label">Toplam Mesafe</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon" aria-hidden="true">
                    <ion-icon name="flash"></ion-icon>
                </div>
                <div class="stat-info">
                    <div class="stat-value" id="max-speed">-</div>
                    <div class="stat-label">Maks. Hız</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon" aria-hidden="true">
                    <ion-icon name="time"></ion-icon>
                </div>
                <div class="stat-info">
                    <div class="stat-value" id="drive-time">-</div>
                    <div class="stat-label">Sürüş Süresi</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon" aria-hidden="true">
                    <ion-icon name="stopwatch"></ion-icon>
                </div>
                <div class="stat-info">
                    <div class="stat-value" id="stop-count">0</div>
                    <div class="stat-label">Duraklama</div>
                </div>
            </div>
        </div>

        <div class="tab-navigation" role="tablist">
            <button class="tab-btn active" data-tab="stops" role="tab" aria-selected="true">
                <ion-icon name="location" aria-hidden="true"></ion-icon>
                Duraklar
            </button>
            <button class="tab-btn" data-tab="analysis" role="tab" aria-selected="false">
                <ion-icon name="analytics" aria-hidden="true"></ion-icon>
                Analiz
            </button>
            <button class="tab-btn" data-tab="export" role="tab" aria-selected="false">
                <ion-icon name="download" aria-hidden="true"></ion-icon>
                Export
            </button>
        </div>

        <div class="tab-content">
            <div id="stops-tab" class="tab-pane active" role="tabpanel">
                <div class="stops-list" id="stops-list">
                    </div>
            </div>

            <div id="analysis-tab" class="tab-pane" role="tabpanel">
                <div class="analysis-section">
                    <h4>Hız Limiti Analizi</h4>
                    <div class="speed-limit-control">
                        <label for="speedLimitSlider">Hız Limiti (km/s):</label>
                        <input type="range" id="speedLimitSlider" min="30" max="120" value="60" step="5" aria-label="Hız limiti ayarı">
                        <span id="speedLimitValue">60 km/s</span>
                    </div>
                    <div class="limit-stats">
                        <div class="limit-stat">
                            <span class="stat-badge danger" id="exceed-count">0</span>
                            <span>Limit Aşımı</span>
                        </div>
                        <div class="limit-stat">
                            <span class="stat-badge warning" id="exceed-time">0sn</span>
                            <span>Aşım Süresi</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="export-tab" class="tab-pane" role="tabpanel">
                <div class="export-options">
                    <button class="export-btn" data-format="json" aria-label="JSON formatında indir">
                        <ion-icon name="document-text" aria-hidden="true"></ion-icon>
                        JSON İndir
                    </button>
                    <button class="export-btn" data-format="gpx" aria-label="GPX formatında indir">
                        <ion-icon name="map" aria-hidden="true"></ion-icon>
                        GPX İndir
                    </button>
                    <button class="export-btn" data-format="pdf" aria-label="PDF raporu indir">
                        <ion-icon name="stats-chart" aria-hidden="true"></ion-icon>
                        PDF Rapor
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="loading-overlay">
    <div class="loading-spinner" aria-hidden="true"></div>
    <p>Veriler yükleniyor...</p>
</div>

<div id="toast-container" aria-live="polite"></div>

<script src="main.js"></script>

<script>
    function detectTelegram() {
        var ua = navigator.userAgent.toLowerCase();
        var isTelegram = ua.includes('telegram');
        var isIos = ua.includes('iphone') || ua.includes('ipad') || ua.includes('ipod');
        
        // Eğer Telegram'dan ve iOS cihazdan giriliyorsa uyarıyı göster
        if (isTelegram && isIos) {
            var warningDiv = document.getElementById('telegram-warning');
            if(warningDiv) {
                warningDiv.style.display = 'block';
                // Mobil header'ı uyarının altına it
                var header = document.getElementById('mobile-header');
                if(header) header.style.top = warningDiv.offsetHeight + "px";
            }
        }
    }

    // Kullanıcıyı Safari'ye yönlendirmeyi dene (veya kopyalat)
    window.openInSystemBrowser = function() {
        // Mevcut URL'yi al
        var url = window.location.href;
        
        // Basit bir alert ile kullanıcıya bilgi ver (iOS bazen oto yönlendirmeyi engeller)
        alert("Lütfen sağ üst köşedeki üç noktaya tıklayın ve 'Tarayıcıda Aç' (Open in Safari) seçeneğini seçin. Bu en güvenli yöntemdir.");
    };

    // Sayfa yüklendiğinde kontrol et
    document.addEventListener('DOMContentLoaded', detectTelegram);
</script>

</body>
</html>
